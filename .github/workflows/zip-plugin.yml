# Nom du workflow
name: G√©n√©rer le Zip et cr√©er une PR sur le site web

# --- D√âCLENCHEUR ---
# Se d√©clenche sur les Pull Requests vers la branche main du d√©p√¥t DIMA
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

# --- T√ÇCHES (JOBS) ---
jobs:
  build-and-create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read # On a juste besoin de lire le d√©p√¥t courant

    steps:
      # √âtape 1 : R√©cup√®re le code du d√©p√¥t DIMA (celui de la PR)
      - name: 1. R√©cup√©ration du code de DIMA
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      # √âtape 2 : Cr√©e l'archive .zip
      - name: 2. Compression du r√©pertoire du plugin
        run: |
          cd "plugin/plugin_chrome/releases/"
          zip -r Plugin-dima.zip Plugin-dima

      # √âtape 3 : Clone le d√©p√¥t M82-SiteWeb
      - name: 3. R√©cup√©ration du d√©p√¥t M82-SiteWeb
        uses: actions/checkout@v4
        with:
          repository: M82-project/M82-SiteWeb
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: M82-SiteWeb

      # √âtape 4 : Copie le zip dans le d√©p√¥t du site web
      - name: 4. Copie du fichier .zip
        run: |
          mv plugin/plugin_chrome/releases/Plugin-dima.zip M82-SiteWeb/static/files/

      # √âtape 5 : Cr√©e une Pull Request dans M82-SiteWeb
      - name: 5. Cr√©ation de la Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          # Sp√©cifie le d√©p√¥t dans lequel on travaille
          path: ./M82-SiteWeb
          # Le PAT est indispensable pour cr√©er une PR dans un autre d√©p√¥t
          token: ${{ secrets.CROSS_REPO_PAT }}
          # Nom de la nouvelle branche qui sera cr√©√©e dans M82-SiteWeb
          branch: "update/plugin-dima-zip"
          # Titre de la Pull Request
          title: "ü§ñ Mise √† jour automatique du Plugin-dima.zip"
          # Description de la Pull Request
          body: |
            Mise √† jour du fichier `Plugin-dima.zip`.
            Cette modification a √©t√© d√©clench√©e automatiquement par un workflow du d√©p√¥t `DIMA`.
          # Message du commit
          commit-message: "feat: Mise √† jour du Plugin-dima.zip"
          # La branche de base sur laquelle la PR doit √™tre faite
          base: master
